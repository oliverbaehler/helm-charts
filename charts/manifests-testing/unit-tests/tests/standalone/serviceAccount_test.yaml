suite: Test ServiceAccount Manifest
templates:
  - standalone.yaml
tests:

##
## Passing Test Scenarios
##

  ##
  ## ServiceAccount Disabled
  - it: Disable ServiceAccount
    set:
      unit:
        serviceAccount:
          values:
            create: false
    asserts:
      - hasDocuments:
          count: 0

  ##
  ## Set all available Values (Check Defaults)
  - it: Set all Values (Non Specific Service)
    set:
      unit:
        serviceAccount:
          values:
            create: true
            apiVersion: "v1beta1"
            labels:
              "test.label/1": "someLabel/1"
              "test.label/2": "someLabel/2"
            annotations:
              "test.annotation/1": "someAnnotation/1"
              "test.annotation/2": "someAnnotation/2"
            automountServiceAccountToken: false
            imagePullSecrets:
              - local-pull-secret: secret
            globalPullSecrets: false
            secrets:
              - secret: reference
              - object:
                  reference: {}
    asserts:
      - isKind:
          of: ServiceAccount
      - isAPIVersion:
          of: v1beta1
      - equal:
          path: metadata.name
          value: "RELEASE-NAME-library-testing"
      - equal:
          path: metadata.labels.[test.label/1]
          value: "someLabel/1"
      - equal:
          path: metadata.labels.[test.label/2]
          value: "someLabel/2"
      - equal:
          path: metadata.annotations.[test.annotation/1]
          value: "someAnnotation/1"
      - equal:
          path: metadata.annotations.[test.annotation/2]
          value: "someAnnotation/2"
      - contains:
          path: secrets
          content:
            secret: reference
      - contains:
          path: secrets
          content:
            object:
              reference: {}
      - contains:
          path: imagePullSecrets
          content:
            local-pull-secret: secret

  ##
  ## ServiceAccount Name
  - it: Set all Values (Non Specific Service)
    set:
      unit:
        serviceAccount:
          values:
            create: true
            name: "account-name"
    asserts:
      - isKind:
          of: ServiceAccount
      - isAPIVersion:
          of: v1
      - equal:
          path: metadata.name
          value: "account-name"


  ##
  ## Minimal Configuration
  - it: Test Minimal Service Configuration
    set:
      unit:
        serviceAccount:
          values:
            create: true
    asserts:
      - isKind:
          of: ServiceAccount
      - isAPIVersion:
          of: v1
      - equal:
          path: metadata.name
          value: "RELEASE-NAME-library-testing"

##
## Global Assertion Scenarios
##

  ##
  ## Global PullPolicy
  - it: Global PullPolicy assertion
    values:
      - ../../values/globals.yaml
    set:
      unit:
        serviceAccount:
          values:
            create: true
            imagePullSecrets:
              - something: secret
            globalPullSecrets: true
    asserts:
      - equal:
          path: metadata.name
          value: "RELEASE-NAME-library-testing"
      - contains:
          path: imagePullSecrets
          content:
            name: private-registry
      - contains:
          path: imagePullSecrets
          content:
            name: private-registry-group
